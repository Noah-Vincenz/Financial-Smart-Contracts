<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="bundle.js"></script>
  <meta charset="utf-8">
  <title>Financial Smart Contracts</title>
  <link rel="stylesheet" type="text/css" href="main.css" />
</head>
<body>
  <div id="outer_container">
    <h1>FSC</h1>
    <div id="top_container">
        <div id="top_input_container">
            <input id="holder_address" type="text" placeholder="Holder Address">
            <div id="collateral_container">
                <p id="collateral">Collateral</p>
                <select id="select_collateral" class="1_100" onchange="changeCollateral(getSelectedCollateral())"></select>
            </div>
            <input id="counter_party_address" type="text" placeholder="Counter-Party Address"><br>
        </div>
        <button class="button" id = "create_contract_button" type="button" onclick="instantiateNew()">Create Contract</button>
        <p class="status" id="contract_status"></p>
    </div>
    <div id="bottom_container">
      <div id="bottom_input_container">
          <div id="scalek_container">
              <p id="scalek">scaleK</p>
              <select id="select_scalek" class="1_100" onchange="changeScaleK(getSelectedScaleK())"></select>
          </div>
          <button class="button" id = "give_button" type="button" onclick="change_given()">give</button>
          <select id="select_one_zero" onchange="changeSelecteOneZero(getSelectedOneZero())">
              <option>one</option>
              <option>zero</option>
          </select><br>
      </div>
      <input id="transaction_input" type="text" placeholder="Transaction">
      <button class="button" id = "send_tx_id" type="button" onclick="makeTransaction(getInputString())">Make Transaction</button>
      <p class="status" id="transaction_status"></p>
    </div>
  </div>
  <script>
    $(function(){
        var $select = $(".1_100");
        for (i=1;i<=100;i++){
            $select.append($('<option></option>').val(i).html(i))
        }
    });

    function changeCollateral(collateralIn) {
        selectedCollateral = collateralIn;
    }

    function getSelectedCollateral() {
        return document.getElementById("select_collateral").value;
    }

    function makeTransaction(inputString) {
        parseInput(inputString, "0", [], 0, 1, 0, "");
    }

    function getInputString() {
        return document.getElementById("transaction_input").value;
    }

    function parseInput(inputString, level, remainingExpr, recipient, amount, acquireAtHorizon, horizonDate) { // level = int starting at 0
      if (inputString.includes("and")) {
          var res = inputString.split("and");
          parseInput(res[0], (parseInt(level) + 1).toString() + "1", res[1], recipient, amount, acquireAtHorizon, horizonDate);
          parseInput(res[1], (parseInt(level) + 1).toString() + "2", [], recipient, amount, acquireAtHorizon, horizonDate);
      } else if (inputString.includes("or")) {
          var res = inputString.split("or");
          parseInput(res[0], (parseInt(level) + 1).toString() + "1", res[1], recipient, amount, acquireAtHorizon, horizonDate);
          parseInput(res[1], (parseInt(level) + 1).toString() + "2", [], recipient, amount, acquireAtHorizon, horizonDate);
      } else {
          var newStr = inputString.replace(/[()]/g, '');
          var strArr = newStr.split(" ");
          var i;
          for (i = 0; i < strArr.length; ++i) {
              str = strArr[i];
              if (str === "give") {
                  recipient = 1;
              } else if (str === "one") {
                  amount *= 1;
              } else if (str === "zero") {
                  amount *= 0;
              } else if (str === "scaleK") {

                  if (strArr.length > i+1 && Number.isInteger(parseInt(strArr[i+1]))) {
                      amount *= parseInt(strArr);
                      ++i;
                  } else {
                      console.log("'scaleK' should be followed by an integer.");
                      break;
                  }
              } else if (str === "truncate") {
                  if (strArr.length > i+1 && date(lTrimDoubleQuotes(rTrimDoubleQuotes(strArr[i+1])))) {
                      horizonDate = strArr[i+1];
                      ++i;
                  } else {
                      console.log("truncate should be followed by a date in the following pattern: 'dd/mm/yyyy-hh:mm:ss'.");
                      break;
                  }
              } else if (str === "get") {
                  acquireAtHorizon = 1;
              }
          }
          console.log("Subcontract " + level + ": " + rTrimParen(lTrimParen(rTrimWhiteSpace(lTrimWhiteSpace(inputString)))));
      }
    }

    function int(stringInput) {

    }

    function date(stringInput) {
        console.log(stringInput);

        var matches = stringInput.match(/^((0?[1-9])|([12][0-9])|(3[01]))\/((0?[1-9])|(1[0-2]))\/(\d\d\d\d)-((0[0-9])|(1[0-9])|(2[0-3])):([0-5][0-9]):([0-5][0-9])$/);

        if (matches === null) {
            return false;
        } else if (matches[0] === stringInput) {
            return true;
        } else {
            return false;
        }
    }

    function lTrimWhiteSpace(str) {
      if(str == null) return str;
      return str.replace(/^\s+/g, '');
    }

    function rTrimWhiteSpace(str) {
      if(str == null) return str;
      return str.replace(/\s$/g, '');
    }

    function lTrimParen(str) {
      if(str == null) return str;
      return str.replace(/^\(+/g, '');
    }

    function rTrimParen(str) {
      if(str == null) return str;
      return str.replace(/\)$/g, '');
    }

    function lTrimDoubleQuotes(str) {
      if(str == null) return str;
      return str.replace(/^\"+/g, '');
    }

    function rTrimDoubleQuotes(str) {
      if(str == null) return str;
      return str.replace(/\"$/g, '');
    }
  </script>

</body>
