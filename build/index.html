<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="bundle.js"></script>
  <meta charset="utf-8">
  <title>Financial Smart Contracts</title>
  <link rel="stylesheet" type="text/css" href="main.css" />
</head>
<body>
  <div id="outer_container">
    <h1>FSC</h1>
    <div id="top_container">
        <div id="top_input_container">
            <input id="holder_address" type="text" placeholder="Holder Address">
            <div id="collateral_container">
                <p id="collateral">Collateral</p>
                <select id="select_collateral" class="1_100" onchange="changeCollateral(getSelectedCollateral())"></select>
            </div>
            <input id="counter_party_address" type="text" placeholder="Counter-Party Address"><br>
        </div>
        <button class="button" id = "create_contract_button" type="button" onclick="instantiateNew()">Create Contract</button>
        <p class="status" id="contract_status"></p>
    </div>
    <div id="bottom_container">
      <div id="bottom_input_container">
          <div id="scalek_container">
              <p id="scalek">scaleK</p>
              <select id="select_scalek" class="1_100" onchange="changeScaleK(getSelectedScaleK())"></select>
          </div>
          <button class="button" id = "give_button" type="button" onclick="change_given()">give</button>
          <select id="select_one_zero" onchange="changeSelecteOneZero(getSelectedOneZero())">
              <option>one</option>
              <option>zero</option>
          </select><br>
      </div>
      <input id="transaction_input" type="text" placeholder="Transaction">
      <button class="button" id = "send_tx_id" type="button" onclick="makeTransaction(getInputString())">Make Transaction</button>
      <p class="status" id="transaction_status"></p>
    </div>
  </div>
  <script>
    $(function(){
        var $select = $(".1_100");
        for (i=1;i<=100;i++){
            $select.append($('<option></option>').val(i).html(i))
        }
    });

    function changeCollateral(collateralIn) {
        selectedCollateral = collateralIn;
    }

    function getSelectedCollateral() {
        return document.getElementById("select_collateral").value;
    }

    function makeTransaction(inputString) {
        parse(inputString, 0, 1, 0, "");
    }

    function getInputString() {
        return document.getElementById("transaction_input").value;
    }

    function parse(inputString, recipient, amount, acquireAtHorizon, horizonDate) {

      //TODO: add spaces wherever there is no space ie. before and after words/parenthesis
      // TODO: add double space at end
      var stack = [];
      var currentTerm = ""; //keeps track of the term ie and,give,one when initially looping through input & is used to add these to stack
      var currentConj = "";
      var conjunctionStack = []; // whenever stack is empty then conjunctionStack will be popped and used
      var contractString = ""; // used to accumulate the complete contract from its parts one by one when popping off the stack
      var contractsStack = [];
      var firstPartOfConjunction = "";
      var strArr = inputString.split("");
      for (i = 0; i < strArr.length; ++i) {
          str = strArr[i];
          console.log("iteration through array: " + i + ". Symbol: " + str);
          if (str === ")" || i === strArr.length - 1) { // i === strArr.length - 1 so that it also handles case where input does not end with ')'
              if (i === strArr.length - 1 && str !== ")" && currentTerm !== " ") { // for 'give one or zero' case
                  currentTerm += str;
                  console.log("Pushing last term - " + currentTerm + " - on stack.");
                  stack.push(currentTerm);
              } else {
                  contractString = contractString + str;
              }
              currentTerm = "";
              // pop while items off stack until amount of discovered ')' == popped '('
              console.log("contractString initially: " + contractString);

              while (stack.length > 0) {
                  var term = stack.pop();
                  console.log("Stack popping 1 - term: " + term);
                  if (term === "and" || term === "or") {
                      // if already have first and part then add it to it, else only add this to contractsStack
                      /*
                      if (currentConj === "") { // TODO: only do this if 'and' not 'or'

                      }
                      */

                      if (firstPartOfConjunction !== "") { //put them two together
                        currentConj = "";
                        console.log("0.5: Pushing " + firstPartOfConjunction + " " + term + " " + contractString + " to contractsStack");
                        contractsStack.push(firstPartOfConjunction + " " + conjunctionStack.pop() + " " + contractString);
                        contractString = "";
                        firstPartOfConjunction = "";
                      } else {
                        currentConj = term;
                        console.log("1: Pushing " + contractString + " to contractsStack");
                        contractsStack.push(contractString);
                        contractString = "";
                      }

                      /*
                      currentConj = term;
                      console.log("1: Pushing " + contractString + " to contractsStack");
                      contractsStack.push(contractString);
                      contractString = "";
                      */


                  } else if (term === "(") {
                      contractString = term + " " + contractString;
                      break;

                  } else if (term === "zero" || term === "one") { //then add current contractString to contractsStack and start from empty contractString
                      if (contractString.includes("zero") || contractString.includes("one")) {
                          firstPartOfConjunction = contractString;
                          contractString = term;
                      } else {
                          contractString = term + " " + contractString;
                      }
                  } else {
                      contractString = term + " " + contractString;
                  }
              }
              printStack(stack, "termStack");
              printStack(conjunctionStack, "conjunctionStack");
              printStack(contractsStack, "contractsStack");

              if (stack.length == 0 && contractString !== "") {
                  var conj = "";
                  if (strArr.length > i + 2 && strArr[i + 2] === "a") {
                      conj = "and";
                  } else if (strArr.length > i + 2 && strArr[i + 2] === "o") {
                      conj = "or";
                  }
                  console.log("2: Pushing " + contractString + " to contractsStack");
                  contractsStack.push(contractString);

                  contractString = "";
                  conj = "";
              } else if (stack.length == 1 && (stack[0] == "and" || stack[0] == "or")) {
                  var conj = conjunctionStack.pop();
                  if (contractsStack.length > 0) {
                      var combinedContract = contractString + conj + " " + contractsStack.pop();
                      console.log("3: Pushing " + contractString + " to contractsStack");
                      contractsStack.push(combinedContract);
                      if (conj === "or") {
                          createSection();
                          createButton(contractString);
                      }
                  }
                  contractString = "";
                  conj = "";
              }

          } else if (str === " ") {
              // push term
              if (currentTerm !== "") { // not needed
                  console.log("Pushing last term - " + currentTerm + " - on stack.");
                  stack.push(currentTerm);
                  if (currentTerm === "and" || currentTerm === "or") {
                      conjunctionStack.push(currentTerm);
                  }
                  currentTerm = "";
              }
          } else if (str === "(") {
              stack.push(str);
          } else {
             // its part of term
             currentTerm += str;
          }
        }
        // while stack.length > 0 repeat
        if (stack.length > 0) {
            while (stack.length > 0) {
                var term = stack.pop();
                console.log("Stack popping 2 - term: " + term);
                if (term === "and" || term === "or") {
                    currentConj = term;
                    if (contractString !== "" && contractString !== "( ") {
                        console.log("5: Pushing " + contractString + " to contractsStack");
                        contractsStack.push(contractString);
                    }
                    contractString = ""; // to print out the whole contract when all its parts have been discovered
                } else if (term === "(") {
                    contractString = term + " " + contractString;
                    break;
                } else {
                    contractString = term + " " + contractString;
                }
            }
            console.log("Contract string just before end: " + contractString);
            if (contractString !== "") {
                console.log("6: Pushing " + contractString + " to contractsStack");
                contractsStack.push(contractString);
            }
          }
          printStack(stack, "termStack");
          printStack(conjunctionStack, "conjunctionStack");
          printStack(contractsStack, "contractsStack");
          var res = contractsStack.length / conjunctionStack.length;
          while (conjunctionStack.length >= 1 && contractsStack.length >= 2 && res === 2) {
              var contract2 = contractsStack.pop();
              var contract1 = contractsStack.pop();
              var conj = conjunctionStack.pop();
              console.log("Combining leftover contracts...");
              console.log(contract1 + " " + conj + " " + contract2);
              if (conj === "or") {
                  createSection();
                  createButton(contract1);
                  createButton(contract2);
              }
              res = contractsStack.length / conjunctionStack.length;
          }
    }

  function printStack(stack, name) {
      console.log(name + ": " + stack.length);
      var x;
      for (x = 0; x < stack.length; ++x) {
          console.log(stack[x]);
      }
  }

  function createButton(contractString) {
    // 1. Create the button
    var button = document.createElement("button");
    button.innerHTML = contractString;

    // 2. Append somewhere
    var bottomContainer = document.getElementById("bottom_container");
    //var body = document.getElementsByTagName("body")[0];
    bottomContainer.appendChild(button);

    // 3. Add event handler
    button.addEventListener ("click", function() {
        alert("did something");
    });
  }

  function createSection() {
      var para = document.createElement("p");
      var node = document.createTextNode("Contract choice:");
      para.appendChild(node);

      var bottomContainer = document.getElementById("bottom_container");
      bottomContainer.appendChild(para);
  }

  class Contract {

      constructor(recipient, amount, acquireAtHorizon, horizonDate) {
          this.recipient = recipient;
          this.amount = amount;
          this.acquireAtHorizon = acquireAtHorizon;
          this.horizonDate = horizonDate;
      }

      // Adding a method to the constructor
      greet() {
          return `${this.name} says hello.`;
      }

      printContract() {

          return `${this.name} says hello.`;
      }
  }


    function date(stringInput) {

        var matches = stringInput.match(/^((0?[1-9])|([12][0-9])|(3[01]))\/((0?[1-9])|(1[0-2]))\/(\d\d\d\d)-((0[0-9])|(1[0-9])|(2[0-3])):([0-5][0-9]):([0-5][0-9])$/);

        if (matches === null) {
            return false;
        } else if (matches[0] === stringInput) {
            return true;
        } else {
            return false;
        }
    }

    function lTrimWhiteSpace(str) {
      if(str == null) return str;
      return str.replace(/^\s+/g, '');
    }

    function rTrimWhiteSpace(str) {
      if(str == null) return str;
      return str.replace(/\s$/g, '');
    }

    function lTrimParen(str) {
      if(str == null) return str;
      return str.replace(/^\(+/g, '');
    }

    function rTrimParen(str) {
      if(str == null) return str;
      return str.replace(/\)$/g, '');
    }

    function lTrimDoubleQuotes(str) {
      if(str == null) return str;
      return str.replace(/^\"+/g, '');
    }

    function rTrimDoubleQuotes(str) {
      if(str == null) return str;
      return str.replace(/\"$/g, '');
    }
  </script>

</body>
