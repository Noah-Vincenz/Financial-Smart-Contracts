<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="bundle.js"></script>
  <meta charset="utf-8">
  <title>Financial Smart Contracts</title>
  <link rel="stylesheet" type="text/css" href="main.css" />
</head>
<body>
  <div id="outer_container">
    <h1>FSC</h1>
    <div id="top_container">
        <div id="top_input_container">
            <input id="holder_address" type="text" placeholder="Holder Address">
            <div id="collateral_container">
                <p id="collateral">Collateral</p>
                <select id="select_collateral" class="1_100" onchange="changeCollateral(getSelectedCollateral())"></select>
            </div>
            <input id="counter_party_address" type="text" placeholder="Counter-Party Address"><br>
        </div>
        <button class="button" id = "create_contract_button" type="button" onclick="instantiateNew()">Create Contract</button>
        <p class="status" id="contract_status"></p>
    </div>
    <div id="bottom_container">
      <div id="bottom_input_container">
          <div id="scalek_container">
              <p id="scalek">scaleK</p>
              <select id="select_scalek" class="1_100" onchange="changeScaleK(getSelectedScaleK())"></select>
          </div>
          <button class="button" id = "give_button" type="button" onclick="change_given()">give</button>
          <select id="select_one_zero" onchange="changeSelecteOneZero(getSelectedOneZero())">
              <option>one</option>
              <option>zero</option>
          </select><br>
      </div>
      <input id="transaction_input" type="text" placeholder="Transaction">
      <button class="button" id = "send_tx_id" type="button" onclick="makeTransaction(getInputString())">Make Transaction</button>
      <p class="status" id="transaction_status"></p>
    </div>
  </div>
  <script>
    $(function(){
        var $select = $(".1_100");
        for (i=1;i<=100;i++){
            $select.append($('<option></option>').val(i).html(i))
        }
    });

    function changeCollateral(collateralIn) {
        selectedCollateral = collateralIn;
    }

    function getSelectedCollateral() {
        return document.getElementById("select_collateral").value;
    }

    function makeTransaction(inputString) {
        parse(inputString, 0, 0, 1, 0, "");
        //parseInput(inputString, "", "", 0, 1, 0, "");
    }

    function getInputString() {
        return document.getElementById("transaction_input").value;
    }

    function parse(inputString, level, recipient, amount, acquireAtHorizon, horizonDate) {

      //TODO: add spaces before and after parenthesis
      var stack = [];
      var currentTerm = "";
      var currentConj = "";
      var conjunctionStack = []; // whenever stack is empty then conjunctionStack will be popped and used
      var contractString = "";
      var contractsStack = [];
      var strArr = inputString.split("");
      for (i = 0; i < strArr.length; ++i) {
          str = strArr[i];
          console.log("iteration through array: " + i + ". Symbol: " + str);
          if (str === " ") {
              // push term
              console.log("Empty Space");
              if (currentTerm !== "") {
                  console.log("Pushing last term - " + currentTerm + " - on stack.");
                  stack.push(currentTerm);
                  if (currentTerm === "and" || currentTerm === "or") {
                      conjunctionStack.push(currentTerm);
                  }
                  currentTerm = "";
              }
          } else if (str === "(") {
              console.log("Opening paren");
              stack.push(str);
          } else if (str === ")") {
              console.log("Closing paren");
              // pop while items off stack until amount of discovered ')' == popped '('
              contractString = contractString + ")";
              while (stack.length > 0) {
                  var term = stack.pop();
                  console.log("While loop iteration - term: " + term);
                  if (term === "and" || term === "or") {
                      //conjunctionStack.push(term);
                      currentConj = term;
                      ++level;
                      console.log("Subcontract: " + level + ": " + "\n currentConj: " + currentConj +  "\n recipient: " + recipient + "\n amount: " + amount + "\n acquireAtHorizon: " + acquireAtHorizon + "\n horizonDate: " + horizonDate);
                      console.log(contractString);
                      contractsStack.push(contractString);
                      contractString = ""; // to print out the whole contract when all its parts have been discovered
                      currentTerm = "";
                      recipient = 0;
                      amount = 1;
                      acquireAtHorizon = 0;
                      horizonDate = "";
                  } else if (term === "give") {
                      contractString = term + " " + contractString;
                      recipient = 1;
                  } else if (term === "one") {
                      contractString = term + " " + contractString;
                      amount *= 1;
                  } else if (term === "zero") {
                      contractString = term + " " + contractString;
                      amount *= 0;
                  } else if (term === "get") {
                      contractString = term + " " + contractString;
                      acquireAtHorizon = 1;
                  } else if (term === "scaleK" || term === "truncate") {
                      contractString = term + " " + contractString;
                      // skip
                  } else if (Number.isInteger(parseInt(term))) {
                      contractString = term + " " + contractString;
                      amount *= parseInt(term);
                  } else if (term === "(") {
                      contractString = term + " " + contractString;
                      break;
                  } else if (date(lTrimDoubleQuotes(rTrimDoubleQuotes(term)))) {
                      contractString = term + " " + contractString;
                      horizonDate = term;
                  }
              }

              console.log("Stack size: " + stack.length);
              console.log("conjunctionStack");
              var x1;
              for (x1 = 0; x1 < conjunctionStack.length; ++x1) {
                  console.log(conjunctionStack[x1]);
              }
              console.log("contractsStack");
              var x2;
              for (x2 = 0; x2 < contractsStack.length; ++x2) {
                  console.log(contractsStack[x2]);
              }

              if (stack.length == 0) {
                  var conj = "";
                  if (strArr.length > i + 2 && strArr[i + 2] === "a") {
                      //conjunctionStack.push("and");
                      conj = "and";
                  } else if (strArr.length > i + 2 && strArr[i + 2] === "o") {
                      //conjunctionStack.push("or"); // this is done twice, no?
                      conj = "or";
                  }
                  //console.log("Subcontract: " + level + ": " + "\n currentConj: " + currentConj +  "\n recipient: " + recipient + "\n amount: " + amount + "\n acquireAtHorizon: " + acquireAtHorizon + "\n horizonDate: " + horizonDate);
                  console.log("Subcontract: " + level + ": " + "\n currentConj: " + conj +  "\n recipient: " + recipient + "\n amount: " + amount + "\n acquireAtHorizon: " + acquireAtHorizon + "\n horizonDate: " + horizonDate);
                  console.log(contractString);
                  contractsStack.push(contractString);
                  contractString = "";
                  currentTerm = "";
                  conj = "";
                  recipient = 0;
                  amount = 1;
                  acquireAtHorizon = 0;
                  horizonDate = "";
              } else if (stack.length == 1 && (stack[0] == "and" || stack[0] == "or")) {
                  var conj = conjunctionStack.pop();
                  console.log("Subcontract: " + level + ": " + "\n currentConj: " + conj +  "\n recipient: " + recipient + "\n amount: " + amount + "\n acquireAtHorizon: " + acquireAtHorizon + "\n horizonDate: " + horizonDate);
                  console.log(contractString);
                  if (contractsStack.length > 0) {
                      var combinedContract = contractString + conj + " " + contractsStack.pop();
                      console.log(combinedContract);
                      contractsStack.push(combinedContract);
                  }
                  contractString = "";
                  currentTerm = "";
                  conj = "";
                  recipient = 0;
                  amount = 1;
                  acquireAtHorizon = 0;
                  horizonDate = "";

                  // TODO: empty contractsStack and left over conj to combine contracts
              }

          } else {
             // its part of term
             currentTerm += str;
          }
    }
    // TODO: empty contractsStack and left over conj to combine contracts
    var res = contractsStack.length / conjunctionStack.length;
    while (conjunctionStack.length >= 1 && contractsStack.length >= 2 && res === 2) {
        var contract2 = contractsStack.pop();
        var contract1 = contractsStack.pop();
        console.log(contract1 + " " + conjunctionStack.pop() + " " + contract2);
        res = contractsStack.length / conjunctionStack.length;
    }
  }

  class Contract {

      constructor(recipient, amount, acquireAtHorizon, horizonDate) {
          this.recipient = recipient;
          this.amount = amount;
          this.acquireAtHorizon = acquireAtHorizon;
          this.horizonDate = horizonDate;
      }

      // Adding a method to the constructor
      greet() {
          return `${this.name} says hello.`;
      }

      printContract() {

          return `${this.name} says hello.`;
      }
  }

    function parseInput(inputString, level, andOr, recipient, amount, acquireAtHorizon, horizonDate) { // level = int starting at 0
      if (inputString.includes(") and (")) {
          var res = inputString.split(") and (");
          parseInput(res[0], level + "1", "and", recipient, amount, acquireAtHorizon, horizonDate);
          parseInput(res[1], level + "2", "and", recipient, amount, acquireAtHorizon, horizonDate);
      } else if (inputString.includes(") or (")) {
          var res = inputString.split(") or (");
          parseInput(res[0], level + "1", "or", recipient, amount, acquireAtHorizon, horizonDate);
          parseInput(res[1], level + "2", "or", recipient, amount, acquireAtHorizon, horizonDate);
      } else if (inputString.includes(") and")) {
          var res = inputString.split(") and");
          parseInput(res[0], level + "1", "and", recipient, amount, acquireAtHorizon, horizonDate);
          parseInput(res[1], level + "2", "and", recipient, amount, acquireAtHorizon, horizonDate);
      } else if (inputString.includes(") or")) {
          var res = inputString.split(") or");
          parseInput(res[0], level + "1", "or", recipient, amount, acquireAtHorizon, horizonDate);
          parseInput(res[1], level + "2", "or", recipient, amount, acquireAtHorizon, horizonDate);
      } else if (inputString.includes("and (")) {
          var res = inputString.split("and (");
          parseInput(res[0], level + "1", "and", recipient, amount, acquireAtHorizon, horizonDate);
          parseInput(res[1], level + "2", "and", recipient, amount, acquireAtHorizon, horizonDate);
      } else if (inputString.includes("or (")) {
          var res = inputString.split("or (");
          parseInput(res[0], level + "1", "or", recipient, amount, acquireAtHorizon, horizonDate);
          parseInput(res[1], level + "2", "or", recipient, amount, acquireAtHorizon, horizonDate);
      } else if (inputString.includes("and")) {
          var res = inputString.split("and");
          parseInput(res[0], level + "1", "and", recipient, amount, acquireAtHorizon, horizonDate);
          parseInput(res[1], level + "2", "and", recipient, amount, acquireAtHorizon, horizonDate);
      } else if (inputString.includes("or")) {
          var res = inputString.split("or");
          parseInput(res[0], level + "1", "or", recipient, amount, acquireAtHorizon, horizonDate);
          parseInput(res[1], level + "2", "or", recipient, amount, acquireAtHorizon, horizonDate);
      } else {
          var newStr = inputString.replace(/[()]/g, '');
          var strArr = newStr.split(" ");
          var i;
          for (i = 0; i < strArr.length; ++i) {
              str = strArr[i];
              if (str === "give") {
                  recipient = 1;
              } else if (str === "one") {
                  amount *= 1;
              } else if (str === "zero") {
                  amount *= 0;
              } else if (str === "scaleK") {

                  if (strArr.length > i+1 && Number.isInteger(parseInt(strArr[i+1]))) {
                      amount *= parseInt(strArr);
                      ++i;
                  } else {
                      console.log("'scaleK' should be followed by an integer.");
                      break;
                  }
              } else if (str === "truncate") {
                  if (strArr.length > i+1 && date(lTrimDoubleQuotes(rTrimDoubleQuotes(strArr[i+1])))) {
                      horizonDate = strArr[i+1];
                      ++i;
                  } else {
                      console.log("'truncate' should be followed by a valid date in the following pattern: 'dd/mm/yyyy-hh:mm:ss'.");
                      break;
                  }
              } else if (str === "get") {
                  acquireAtHorizon = 1;
              }
          }
          console.log("Subcontract " + level + ": " + andOr + ": " + rTrimParen(lTrimParen(rTrimWhiteSpace(lTrimWhiteSpace(inputString)))));
      }
    }

    function int(stringInput) {

    }

    function date(stringInput) {
        console.log(stringInput);

        var matches = stringInput.match(/^((0?[1-9])|([12][0-9])|(3[01]))\/((0?[1-9])|(1[0-2]))\/(\d\d\d\d)-((0[0-9])|(1[0-9])|(2[0-3])):([0-5][0-9]):([0-5][0-9])$/);

        if (matches === null) {
            return false;
        } else if (matches[0] === stringInput) {
            return true;
        } else {
            return false;
        }
    }

    function lTrimWhiteSpace(str) {
      if(str == null) return str;
      return str.replace(/^\s+/g, '');
    }

    function rTrimWhiteSpace(str) {
      if(str == null) return str;
      return str.replace(/\s$/g, '');
    }

    function lTrimParen(str) {
      if(str == null) return str;
      return str.replace(/^\(+/g, '');
    }

    function rTrimParen(str) {
      if(str == null) return str;
      return str.replace(/\)$/g, '');
    }

    function lTrimDoubleQuotes(str) {
      if(str == null) return str;
      return str.replace(/^\"+/g, '');
    }

    function rTrimDoubleQuotes(str) {
      if(str == null) return str;
      return str.replace(/\"$/g, '');
    }
  </script>

</body>
